name: "Services Cache Warming"

on:
  schedule:
    - cron: "0 5 * * *" # Every day at 5 AM UTC
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to warm cache for (comma-separated or "all")'
        required: true
        default: "all"

permissions:
  contents: read
  packages: read # Required for docker/login-action to authenticate with GHCR
  actions: read # Required for cache-from: type=gha

jobs:
  build-matrix:
    name: Build matrix
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.matrix.outputs.services }}
    steps:
      - uses: actions/checkout@v4

      # Builds a JSON array of service names to fan out into parallel cache warming jobs.
      # On manual dispatch with specific services, validates input and uses the comma-separated input.
      # Otherwise (scheduled or "all"), auto-discovers services from the services/ directory.
      - name: Build service matrix
        id: matrix
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_SERVICES: ${{ github.event.inputs.services }}
        run: |
          available=$(find services -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort)

          if [ "$EVENT_NAME" = "workflow_dispatch" ] && [ "$INPUT_SERVICES" != "all" ]; then
            IFS=',' read -ra requested <<< "$INPUT_SERVICES"
            valid=()
            for service in "${requested[@]}"; do
              service=$(echo "$service" | xargs)
              if echo "$available" | grep -qx "$service"; then
                valid+=("$service")
              else
                echo "::error::Unknown service: $service"
                echo "Available services: $available"
                exit 1
              fi
            done
            services=$(printf '%s\n' "${valid[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            services=$(echo "$available" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
          echo "services=$services" >> "$GITHUB_OUTPUT"

  # Fans out into one job per service using the reusable cache template.
  # Dockerfile paths are derived from the convention: services/<name>/deploy/Dockerfile
  cache:
    name: ${{ matrix.service }}
    needs: build-matrix
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.build-matrix.outputs.services) }}
    uses: ./.github/workflows/_template-cache.yaml
    with:
      service-name: ${{ matrix.service }}
      service-path: services/${{ matrix.service }}
