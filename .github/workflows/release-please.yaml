name: "Release, Please ðŸ¤–"

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write
  issues: write
  packages: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      "services/factset-mcp--release_created": ${{ steps.release.outputs['services/factset-mcp--release_created'] }}
      "services/factset-mcp--version": ${{ steps.release.outputs['services/factset-mcp--version'] }}
      "services/outlook-mcp--release_created": ${{ steps.release.outputs['services/outlook-mcp--release_created'] }}
      "services/outlook-mcp--version": ${{ steps.release.outputs['services/outlook-mcp--version'] }}
      "services/sharepoint-connector--release_created": ${{ steps.release.outputs['services/sharepoint-connector--release_created'] }}
      "services/sharepoint-connector--version": ${{ steps.release.outputs['services/sharepoint-connector--version'] }}
      "services/teams-mcp--release_created": ${{ steps.release.outputs['services/teams-mcp--release_created'] }}
      "services/teams-mcp--version": ${{ steps.release.outputs['services/teams-mcp--version'] }}

    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release

      - name: Debug release outputs
        continue-on-error: true # even if the nice printout fails, we want to continue
        env:
          RELEASE_OUTPUTS: ${{ toJson(steps.release.outputs) }}
        run: |
          echo "$RELEASE_OUTPUTS" | jq
          echo '## Release Please Outputs' >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$RELEASE_OUTPUTS" | jq . >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  release-factset-mcp:
    needs: release-please
    if: ${{ needs.release-please.outputs['services/factset-mcp--release_created'] == 'true' }}
    uses: ./.github/workflows/_template-cd.yaml
    with:
      service-name: factset-mcp
      service-version: ${{ needs.release-please.outputs['services/factset-mcp--version'] }}

  release-outlook-mcp:
    needs: release-please
    if: ${{ needs.release-please.outputs['services/outlook-mcp--release_created'] == 'true' }}
    uses: ./.github/workflows/_template-cd.yaml
    with:
      service-name: outlook-mcp
      service-version: ${{ needs.release-please.outputs['services/outlook-mcp--version'] }}
      dockerfile: services/outlook-mcp/deploy/Dockerfile

  release-sharepoint-connector:
    needs: release-please
    if: ${{ needs.release-please.outputs['services/sharepoint-connector--release_created'] == 'true' }}
    uses: ./.github/workflows/_template-cd.yaml
    with:
      service-name: sharepoint-connector
      service-version: ${{ needs.release-please.outputs['services/sharepoint-connector--version'] }}
      dockerfile: services/sharepoint-connector/deploy/Dockerfile

  release-teams-mcp:
    needs: release-please
    if: ${{ needs.release-please.outputs['services/teams-mcp--release_created'] == 'true' }}
    uses: ./.github/workflows/_template-cd.yaml
    with:
      service-name: teams-mcp
      service-version: ${{ needs.release-please.outputs['services/teams-mcp--version'] }}
      dockerfile: services/teams-mcp/deploy/Dockerfile
      docs-path: services/teams-mcp/docs
