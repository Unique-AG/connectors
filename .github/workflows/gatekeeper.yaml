name: "ðŸš§ Gatekeeper"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches:
      - main

jobs:
  conventional-pr-title:
    runs-on: ubuntu-latest
    name: Validate PR title and scope
    # Skip automated PRs (release-please, dependabot) by label
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'autorelease: pending') && !contains(github.event.pull_request.labels.*.name, 'autorelease: tagged') && !contains(github.event.pull_request.labels.*.name, 'dependencies') }}
    permissions:
      pull-requests: read
    env:
      GH_TOKEN: ${{ github.token }}
      PR_NUMBER: ${{ github.event.number }}
      PR_TITLE: ${{ github.event.pull_request.title }}
    steps:
      - uses: actions/checkout@v6

      - uses: cachix/install-nix-action@v30

      - name: Validate PR title
        run: |
          FILES=$(gh pr view "$PR_NUMBER" --json files -q '.files[].path' | tr '\n' ' ')

          if ! OUTPUT=$(echo "$PR_TITLE" | nix shell github:proventuslabs/scriptorium#cz --command cz lint --paths "$FILES" 2>&1); then
            echo "::error title=Invalid PR Title::$OUTPUT"
            exit 1
          fi

  gatekeeper:
    runs-on: ubuntu-latest
    permissions:
      checks: read
      statuses: read
      pull-requests: read
    steps:
      - name: Run Merge Gatekeeper
        uses: upsidr/merge-gatekeeper@09af7a82c1666d0e64d2bd8c01797a0bcfd3bb5d #v1.2.1
        timeout-minutes: 15
        with:
          self: gatekeeper
          token: ${{ secrets.GITHUB_TOKEN }}
