name: "ðŸš§ Gatekeeper"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches:
      - main

jobs:
  conventional-pr-title:
    runs-on: ubuntu-latest
    name: Validate PR title and scope
    # Skip automated PRs (release-please, dependabot) and urgent PRs by label
    if: "!contains(github.event.pull_request.labels.*.name, 'autorelease: pending') && !contains(github.event.pull_request.labels.*.name, 'autorelease: tagged') && !contains(github.event.pull_request.labels.*.name, 'dependencies') && !contains(github.event.pull_request.labels.*.name, 'skip-validation')"
    permissions:
      pull-requests: read
    env:
      GH_TOKEN: ${{ github.token }}
      PR_NUMBER: ${{ github.event.number }}
      PR_TITLE: ${{ github.event.pull_request.title }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Validate PR title
        run: |
          export FILES=$(gh pr view "$PR_NUMBER" --json files -q '.files[].path' | tr '\n' ' ')

          # Source shell plugin (nix shell has stdin/stdout issues in GitHub Actions)
          git -c init.defaultBranch=main init --quiet /tmp/scriptorium
          git -C /tmp/scriptorium fetch --depth 1 --quiet https://github.com/proventuslabs/scriptorium.git 924e9a72df74224b7d237974f4c7e5d5c432d574 # cz-v0.1.0
          git -C /tmp/scriptorium checkout --quiet FETCH_HEAD
          source /tmp/scriptorium/scriptorium.plugin.sh

          # printenv outputs values directly without any shell interpretation
          if ! OUTPUT=$(printenv PR_TITLE | cz lint --paths "$(printenv FILES)" 2>&1); then
            echo "::error title=Invalid PR Title::$OUTPUT"
            exit 1
          fi

          # Alternative: nix shell (currently has stdin/stdout issues in GitHub Actions)
          # nix shell github:proventuslabs/scriptorium#cz --command bash -c 'printenv PR_TITLE | cz lint --paths "$(printenv FILES)"'

  gatekeeper:
    runs-on: ubuntu-latest
    permissions:
      checks: read
      statuses: read
      pull-requests: read
    steps:
      - name: Run Merge Gatekeeper
        uses: upsidr/merge-gatekeeper@09af7a82c1666d0e64d2bd8c01797a0bcfd3bb5d #v1.2.1
        timeout-minutes: 15
        with:
          self: gatekeeper
          token: ${{ secrets.GITHUB_TOKEN }}
