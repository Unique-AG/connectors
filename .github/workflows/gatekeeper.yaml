name: "ðŸš§ Gatekeeper"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches:
      - main

jobs:
  conventional-pr-title:
    runs-on: ubuntu-latest
    name: Validate PR title and scope
    # Skip automated PRs (release-please, dependabot) and urgent PRs by label
    if: "!contains(github.event.pull_request.labels.*.name, 'autorelease: pending') && !contains(github.event.pull_request.labels.*.name, 'autorelease: tagged') && !contains(github.event.pull_request.labels.*.name, 'dependencies') && !contains(github.event.pull_request.labels.*.name, 'skip-validation')"
    permissions:
      pull-requests: read
    env:
      GH_TOKEN: ${{ github.token }}
      PR_NUMBER: ${{ github.event.number }}
      PR_TITLE: ${{ github.event.pull_request.title }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: cachix/install-nix-action@08dcb3a5e62fa31e2da3d490afc4176ef55ecd72 # v30

      - name: Validate PR title
        run: |
          FILES=$(gh pr view "$PR_NUMBER" --json files -q '.files[].path' | tr '\n' ' ')
          CONFIG="$PWD/.gitcommitizen"

          # Run cz lint - write to temp file inside nix shell to avoid stdin pipe issues
          # --impure allows environment variables to pass through nix shell's pure mode
          echo "Running: cz -c $CONFIG lint --paths $FILES"
          echo "PR_TITLE: $PR_TITLE"
          export PR_TITLE CONFIG FILES
          nix shell --impure github:proventuslabs/scriptorium#cz --command bash -c 'printf "%s\n" "$PR_TITLE" > /tmp/title.txt && cz -c "$CONFIG" lint --paths $FILES < /tmp/title.txt'
          CZ_EXIT=$?
          echo "cz lint exit code: $CZ_EXIT"

          if [ $CZ_EXIT -ne 0 ]; then
            echo "::error title=Invalid PR Title::cz lint failed"
            exit 1
          fi

  gatekeeper:
    runs-on: ubuntu-latest
    permissions:
      checks: read
      statuses: read
      pull-requests: read
    steps:
      - name: Run Merge Gatekeeper
        uses: upsidr/merge-gatekeeper@09af7a82c1666d0e64d2bd8c01797a0bcfd3bb5d #v1.2.1
        timeout-minutes: 15
        with:
          self: gatekeeper
          token: ${{ secrets.GITHUB_TOKEN }}
