name: "ðŸš§ Gatekeeper"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches:
      - main

jobs:
  conventional-pr-title:
    runs-on: ubuntu-latest
    name: Validate PR title and scope
    # Skip automated PRs (release-please, dependabot) and urgent PRs by label
    if: "!contains(github.event.pull_request.labels.*.name, 'autorelease: pending') && !contains(github.event.pull_request.labels.*.name, 'autorelease: tagged') && !contains(github.event.pull_request.labels.*.name, 'dependencies') && !contains(github.event.pull_request.labels.*.name, 'skip-validation')"
    permissions:
      pull-requests: read
    env:
      GH_TOKEN: ${{ github.token }}
      PR_NUMBER: ${{ github.event.number }}
      PR_TITLE: ${{ github.event.pull_request.title }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: cachix/install-nix-action@08dcb3a5e62fa31e2da3d490afc4176ef55ecd72 # v30

      - name: Validate PR title
        run: |
          FILES=$(gh pr view "$PR_NUMBER" --json files -q '.files[].path' | tr '\n' ' ')
          CONFIG="$PWD/.gitcommitizen"

          echo "=== DEBUG: Basic info ==="
          echo "PR_TITLE: $PR_TITLE"
          echo "FILES: $FILES"
          echo "CONFIG: $CONFIG"

          echo "=== DEBUG: nix shell echo test ==="
          nix shell github:proventuslabs/scriptorium#cz --command echo "hello from nix shell"
          echo "nix shell echo exit: $?"

          echo "=== DEBUG: nix shell approach ==="
          nix shell github:proventuslabs/scriptorium#cz --command cz --version 2>&1
          nix shell github:proventuslabs/scriptorium#cz --command cz parse 2>&1
          printf '%s\n' "$PR_TITLE" | nix shell github:proventuslabs/scriptorium#cz --command cz lint --paths $FILES 2>&1
          echo "nix shell pipe exit: $?"

          echo "=== DEBUG: nix shell with bash -c ==="
          nix shell github:proventuslabs/scriptorium#cz --command bash -c "printf '%s\n' '$PR_TITLE' | cz lint --paths $FILES"
          echo "nix shell bash -c exit: $?"

          echo "=== DEBUG: nix run echo test ==="
          nix run nixpkgs#hello || echo "nix run hello failed"
          echo "nix run echo exit: $?"

          echo "=== DEBUG: nix run approach ==="
          nix run github:proventuslabs/scriptorium#cz -- --version || echo "nix run --version failed"
          nix run github:proventuslabs/scriptorium#cz -- parse || echo "nix run parse failed"
          printf '%s\n' "$PR_TITLE" | nix run github:proventuslabs/scriptorium#cz -- lint --paths $FILES || true
          echo "nix run pipe exit: $?"

  gatekeeper:
    runs-on: ubuntu-latest
    permissions:
      checks: read
      statuses: read
      pull-requests: read
    steps:
      - name: Run Merge Gatekeeper
        uses: upsidr/merge-gatekeeper@09af7a82c1666d0e64d2bd8c01797a0bcfd3bb5d #v1.2.1
        timeout-minutes: 15
        with:
          self: gatekeeper
          token: ${{ secrets.GITHUB_TOKEN }}
