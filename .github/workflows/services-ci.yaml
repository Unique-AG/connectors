name: "Services CI"

on:
  pull_request:
    branches:
      - main
    paths:
      - "services/**"
      - "packages/**"
      - "pnpm-lock.yaml"
      - ".github/workflows/services-ci.yaml"
      - ".github/workflows/_template-ci.yaml"
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to run CI for (comma-separated, e.g., "teams-mcp,outlook-mcp" or "all")'
        required: true
        default: "all"

concurrency:
  group: services-ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.build-matrix.outputs.services }}
      packages-changed: ${{ steps.filter.outputs.packages }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        if: github.event_name != 'workflow_dispatch'
        id: filter
        with:
          list-files: json
          filters: |
            services:
              - 'services/**'
            packages:
              - 'packages/**'

      - name: Build service matrix
        id: build-matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            input="${{ github.event.inputs.services }}"
            available=$(find services -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort)

            if [ "$input" = "all" ]; then
              services=$(echo "$available" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            else
              IFS=',' read -ra requested <<< "$input"
              valid=()
              for service in "${requested[@]}"; do
                service=$(echo "$service" | xargs)
                if echo "$available" | grep -qx "$service"; then
                  valid+=("$service")
                else
                  echo "::error::Unknown service: $service"
                  echo "Available services: $available"
                  exit 1
                fi
              done
              services=$(printf '%s\n' "${valid[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            fi
          elif [ "${{ steps.filter.outputs.services }}" = "true" ]; then
            changed='${{ steps.filter.outputs.services_files }}'
            services=$(echo "$changed" | jq -r '.[]' | grep -E '^services/[^/]+/' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          elif [ "${{ steps.filter.outputs.packages }}" = "true" ]; then
            # If only packages changed, run CI for all services that depend on them
            services=$(find services -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            services='[]'
          fi
          echo "services=$services" >> "$GITHUB_OUTPUT"
          echo "Services to validate: $services"

  ci:
    name: ${{ matrix.service }}
    needs: detect-changes
    if: needs.detect-changes.outputs.services != '[]'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
        include:
          - service: factset-mcp
            orm: prisma
          - service: outlook-mcp
            orm: none
          - service: sharepoint-connector
            orm: none
          - service: teams-mcp
            orm: drizzle
    uses: ./.github/workflows/_template-ci.yaml
    with:
      service-name: ${{ matrix.service }}
      service-path: services/${{ matrix.service }}
      orm: ${{ matrix.orm }}
