{{- if .Values.connectorConfig.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: sharepoint-connector-tenant-config
  labels:
    {{- include "chart.labels" . | nindent 4 }}
data:
  default-tenant-config.yaml: |
    # SharePoint Configuration
    sharepoint:
      tenantId: {{ .Values.connectorConfig.sharepoint.tenantId | quote }}
      auth:
        mode: {{ .Values.connectorConfig.sharepoint.auth.mode | quote }}
        {{- if eq .Values.connectorConfig.sharepoint.auth.mode "certificate" }}
        clientId: {{ .Values.connectorConfig.sharepoint.auth.clientId | quote }}
        privateKeyPath: {{ .Values.connectorConfig.sharepoint.auth.privateKeyPath | quote }}
        # privateKeyPassword is loaded from environment variable (secret) if key is encrypted
        {{- if .Values.connectorConfig.sharepoint.auth.thumbprintSha1 }}
        thumbprintSha1: {{ .Values.connectorConfig.sharepoint.auth.thumbprintSha1 | quote }}
        {{- end }}
        {{- if .Values.connectorConfig.sharepoint.auth.thumbprintSha256 }}
        thumbprintSha256: {{ .Values.connectorConfig.sharepoint.auth.thumbprintSha256 | quote }}
        {{- end }}
        {{- end }}
      baseUrl: {{ .Values.connectorConfig.sharepoint.baseUrl | quote }}
      {{- if .Values.connectorConfig.sharepoint.apiRateLimitPerMinuteThousands }}
      graphApiRateLimitPerMinuteThousands: {{ .Values.connectorConfig.sharepoint.apiRateLimitPerMinuteThousands }}
      {{- end }}
      # Sites Configuration
      sitesSource: {{ .Values.connectorConfig.sharepoint.sitesSource | quote }}
      {{- if eq .Values.connectorConfig.sharepoint.sitesSource "sharepoint_list" }}
      sharepointList:
        {{- with .Values.connectorConfig.sharepoint.sharepointList }}
        siteId: {{ .siteId | quote }}
        listId: {{ .listId | quote }}
        {{- end }}
      {{- else if eq .Values.connectorConfig.sharepoint.sitesSource "config_file" }}
      sites:
        {{- range .Values.connectorConfig.sharepoint.sites }}
        - siteId: {{ .siteId | quote }}
          syncColumnName: {{ .syncColumnName | quote }}
          ingestionMode: {{ .ingestionMode | quote }}
          scopeId: {{ .scopeId | quote }}
          {{- if .maxFilesToIngest }}
          maxFilesToIngest: {{ .maxFilesToIngest }}
          {{- end }}
          storeInternally: {{ .storeInternally | quote }}
          syncStatus: {{ .syncStatus | quote }}
          syncMode: {{ .syncMode | quote }}
          {{- if .permissionsInheritanceMode }}
          permissionsInheritanceMode: {{ .permissionsInheritanceMode | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
    # Unique API Configuration
    unique:
      serviceAuthMode: {{ .Values.connectorConfig.unique.authMode | quote }}
      {{- if eq .Values.connectorConfig.unique.authMode "cluster_local" }}
      serviceExtraHeaders:
        {{- range $key, $value := .Values.connectorConfig.unique.serviceExtraHeaders }}
        {{ $key }}: {{ $value | quote }}
        {{- end }}
      {{- end }}
      {{- if eq .Values.connectorConfig.unique.authMode "external" }}
      zitadelOauthTokenUrl: {{ .Values.connectorConfig.unique.zitadel.oauthTokenUrl | quote }}
      zitadelProjectId: {{ .Values.connectorConfig.unique.zitadel.projectId | quote }}
      zitadelClientId: {{ .Values.connectorConfig.unique.zitadel.clientId | quote }}
      # zitadelClientSecret is loaded from environment variable (secret)
      {{- end }}
      ingestionServiceBaseUrl: {{ .Values.connectorConfig.unique.ingestionServiceBaseUrl | quote }}
      scopeManagementServiceBaseUrl: {{ .Values.connectorConfig.unique.scopeManagementServiceBaseUrl | quote }}
      {{- if .Values.connectorConfig.unique.apiRateLimitPerMinute }}
      apiRateLimitPerMinute: {{ .Values.connectorConfig.unique.apiRateLimitPerMinute }}
      {{- end }}
      {{- if .Values.connectorConfig.unique.ingestionConfig }}
      ingestionConfig:
        {{- toYaml .Values.connectorConfig.unique.ingestionConfig | nindent 8 }}
      {{- end }}
    # Processing Configuration
    processing:
      {{- if .Values.connectorConfig.processing.stepTimeoutSeconds }}
      stepTimeoutSeconds: {{ .Values.connectorConfig.processing.stepTimeoutSeconds }}
      {{- end }}
      concurrency: {{ .Values.connectorConfig.processing.concurrency }}
      {{- if .Values.connectorConfig.processing.maxFileSizeToIngestBytes }}
      maxFileSizeToIngestBytes: {{ .Values.connectorConfig.processing.maxFileSizeToIngestBytes }}
      {{- end }}
      allowedMimeTypes:
        {{- range .Values.connectorConfig.processing.allowedMimeTypes }}
        - {{ . | quote }}
        {{- end }}
      {{- if .Values.connectorConfig.processing.scanIntervalCron }}
      scanIntervalCron: {{ .Values.connectorConfig.processing.scanIntervalCron | quote }}
      {{- end }}
{{- end }}
