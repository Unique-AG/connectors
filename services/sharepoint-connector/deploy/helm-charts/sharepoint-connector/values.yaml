connector:
  deployment:
    metadata:
      annotations:
        reloader.stakater.com/auto: "true"
  env:
    LOG_LEVEL: info
    MAX_FILE_SIZE_BYTES: "209715200"
    MAX_HEAP_MB: 1920
    NODE_ENV: production
    OTEL_EXPORTER_PROMETHEUS_HOST: "0.0.0.0"
    OTEL_EXPORTER_PROMETHEUS_PORT: "51346"
    OTEL_METRICS_EXPORTER: "prometheus"
  envVars:
    # -- loading of Zitadel Secret, Users can supersede this with
    # their own secret that contains UNIQUE_ZITADEL_CLIENT_SECRET or use
    # https://artifacthub.io/packages/helm/unique/backend-service?modal=values&path=envVars to load
    # completely arbitrary secret mappings.
    # See also below in connectorConfig.unique.zitadel.clientSecret.
    - name: UNIQUE_ZITADEL_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: sharepoint-connector-secret
          key: UNIQUE_ZITADEL_CLIENT_SECRET
  extraEnvCM:
    - sharepoint-connector-config
  image:
    repository: ghcr.io/unique-ag/connectors/services/sharepoint-connector
    tag: 2.0.0-alpha.12 # x-release-please-version
  networkPolicy:
    enabled: true
    policyTypes:
      # - Egress # We can not yet leverage egress policies as Kubernetes flavor policies do not support FQDN and MS Graph IP-Addresses are not easily deterministic
      - Ingress
    egress: null
  ports:
    application: 51345
    metrics: 51346
  resources:
    # Resources are granted generously as the service for now is a singleton
    limits:
      memory: 2048Mi
    requests:
      cpu: 1
      memory: 1984Mi
  routes:
    paths:
      default:
        enabled: false
  service:
    enabled: false
  serviceAccount:
    enabled: true
    workloadIdentity:
      enabled: true
      clientId: unset_default_value
  # The volume is needed for CorePack afawct
  # FIXME: Correct @konsti?
  volumes:
    - name: tmp
      emptyDir: {}
      # -- Graph/SharePoint Certificate Secret
      # by default the chart expects the certificate to be in a secret named sharepoint-connector-secret under the key key.pem
      # Users can supersede this with their own secret that contains the certificate under a different key or use
      # Users must also set the connectorConfig.sharepoint.auth.privateKeyPath to the path of the certificate in the secret
    - name: sharepoint-connector-secret
      secret:
        secretName: sharepoint-connector-secret
        items:
          - key: key.pem
            path: key.pem
  volumeMounts:
    - name: tmp
      mountPath: /tmp
    - name: sharepoint-connector-secret
      mountPath: /app/key.pem
      subPath: key.pem
      readOnly: true
grafana:
  dashboard:
    enabled: false # TODO: Not yet implemented, template will fail on purpose if enabled
    folder: connectors

# -- config for the deployed connector, will be mapped to the connectors environment variables
# users preferring setting all variables by hand disable the enabled flag and set the extraEnvCM to []
connectorConfig:
  # -- if disabled, connector.extraEnvCM must be set to []
  enabled: true
  sharepoint:
    # -- base url of the sharepoint instance
    # example: https://acme.sharepoint.com
    baseUrl: unset_default_value
    # -- Array of site IDs to scan
    siteIds:
      # Example values
      - 00000000-0000-0000-0000-000000000000
      - 00000000-0000-0000-0000-000000000001
    # -- column name against which the files are synced
    # example: FinanceGPTKnowledge
    syncColumnName: unset_default_value
    auth:
      mode: certificate # oidc, client-secret, certificate
      # -- tenant id against which the graph api calls are made
      # example: 12345678-1234-1234-1234-123456789012
      tenantId: unset_default_value
      clientId: null
      # -- path to the private key file of the Azure AD application certificate in PEM format
      # this closely relates to the volumeMounts and volume definitions in the connector section
      # users wanting to use another path can override this value and unset the volumeMounts and volume definitions
      privateKeyPath: /app/key.pem
      privateKeyPassword: null
      thumbprintSha1: null
      thumbprintSha256: null
    graph:
      apiRateLimitPerMinute: 780000

  unique:
    # -- communication mode for the Unique Services
    # possible values: cluster_local, external
    # cluster_local: comunicates using in-cluster URLs and requires no authentication
    # external: communicates using external URLs and requires authentication via Zitadel
    authMode: cluster_local
    # -- url for the file diff
    # example: https://api.unique.app/ingestion/v1/content/file-diff
    fileDiffUrl: unset_default_value
    # -- url for the ingestion graphql
    # TODO: should use only public urls!
    # example: https://api.unique.app/ingestion/graphql
    ingestionGraphqlUrl: unset_default_value
    # -- url for the scope management graphql
    # example: https://api.unique.app/scope-management/graphql
    scopeManagementGraphqlUrl: unset_default_value
    # flat: sync all files to a single root scope/folder
    # recursive: maintain the folder hierarchy
    ingestionMode: recursive
    # -- name of the root scope/folder in the knowledge base where SharePoint content should be synced (for recursive mode). It will be created by the connector. If this scope name already exists and the service-user does not have read+write access to it it will fail.
    # example: SharePoint Content
    rootScopeName: null
    # -- scope id for the scope based ingestion
    # example: scope_bu4gokr0atzj0kfiuaaaaaaa
    scopeId: null # null if not using scope based ingestion
    apiRateLimitPerMinute: 100
    # -- Object containing extra HTTP headers for ingestion API requests (GraphQL and file diff)
    # Used for service-to-service authentication when using internal cluster URLs
    serviceExtraHeaders: {}
      # x-company-id: 1234567890
      # x-user-id: 1234567890
    zitadel:
      clientId: unset_default_value
      # clientSecret is presented from a secret, see connector.extraEnvSecrets
      oauthTokenUrl: unset_default_value
      # -- project id for the zitadel project
      # example: 225317577440629999
      projectId: unset_default_value
      # -- Object containing extra HTTP headers for Zitadel OAuth requests
      serviceExtraHeaders: {}
        # x-zitadel-instance-host: id.qa.unique.app

  processing:
    stepTimeoutSeconds: 300
    concurrency: 1
    allowedMimeTypes:
      - application/pdf
      - text/plain
      - text/html
      - application/x-asp
      - application/vnd.openxmlformats-officedocument.wordprocessingml.document
      - application/vnd.ms-excel
      - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
      - application/vnd.openxmlformats-officedocument.presentationml.presentation
    maxFileSizeBytes: null
    # -- cron expression for the scheduled SharePoint scan interval default: every 15 minutes
    scanIntervalCron: "*/15 * * * *"
